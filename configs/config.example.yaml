# =============================================================================
# 系统巡检工具配置文件示例
# =============================================================================
#
# 使用方法:
#   1. 复制此文件为 config.yaml
#   2. 修改数据源配置（endpoint、token）
#   3. 根据需要调整阈值和报告配置
#   4. 敏感信息建议使用环境变量：export N9E_TOKEN="your-token"
#
# 环境变量覆盖:
#   所有配置项都可以通过环境变量覆盖，格式为 INSPECT_<节>_<键>
#   例如: INSPECT_DATASOURCES_N9E_TOKEN 覆盖 datasources.n9e.token
#
# =============================================================================

# -----------------------------------------------------------------------------
# 数据源配置
# -----------------------------------------------------------------------------
datasources:
  # 夜莺 (N9E) 监控平台配置
  # 用途: 获取主机元信息（系统类型、版本、内核、IP 等）
  n9e:
    # API 地址 (必填)
    endpoint: "http://${nightingale_api_address}:17000"
    # 认证 Token (必填)
    # 建议使用环境变量: export INSPECT_DATASOURCES_N9E_TOKEN="your-token"
    token: "${N9E_TOKEN}"
    # 请求超时时间 (默认: 30s)
    timeout: 30s
    # 主机过滤查询 (可选)
    # 格式: "标签名=标签值"，支持 N9E 标签查询语法
    # 示例: "items=短剧项目" 只查询标签 items 为"短剧项目"的主机
    # 不配置则获取所有主机
    # query: "items=短剧项目"

  # VictoriaMetrics 时序数据库配置
  # 用途: 查询监控指标数据（CPU、内存、磁盘等）
  victoriametrics:
    # API 地址 (必填)
    endpoint: "http://${victoriametrics_api_address}:8428"
    # 请求超时时间 (默认: 30s)
    timeout: 30s

# -----------------------------------------------------------------------------
# 巡检配置
# -----------------------------------------------------------------------------
inspection:
  # 并发数: 同时采集的主机数量 (默认: 20, 范围: 1-100)
  # 建议: 根据 API 服务器负载能力调整，100+ 主机推荐 20
  concurrency: 20

  # 单主机超时时间 (默认: 10s)
  # 单个主机的数据采集超时，超时后标记为失败但不影响其他主机
  host_timeout: 10s

  # 主机筛选条件 (可选)
  # 不配置则查询所有主机
  host_filter:
    # 业务组筛选 (OR 关系)
    # 匹配任意一个业务组的主机都会被纳入巡检
    business_groups:
      # - "生产环境"
      # - "测试环境"

    # 标签筛选 (AND 关系)
    # 与业务组条件之间是 AND 关系
    # 只有同时满足业务组和标签条件的主机才会被纳入巡检
    tags:
      # env: "prod"
      # region: "cn-east"

# -----------------------------------------------------------------------------
# 告警阈值配置
# -----------------------------------------------------------------------------
# 每个指标包含两个阈值:
#   - warning: 警告阈值 (黄色)
#   - critical: 严重阈值 (红色)
# 规则: warning 必须小于 critical
thresholds:
  # CPU 利用率阈值 (单位: %)
  cpu_usage:
    warning: 70 # CPU > 70% 触发警告
    critical: 90 # CPU > 90% 触发严重告警

  # 内存利用率阈值 (单位: %)
  memory_usage:
    warning: 70 # 内存 > 70% 触发警告
    critical: 90 # 内存 > 90% 触发严重告警

  # 磁盘利用率阈值 (单位: %)
  # 注意: 多磁盘时取最大值进行判断
  disk_usage:
    warning: 70 # 磁盘 > 70% 触发警告
    critical: 90 # 磁盘 > 90% 触发严重告警

  # 僵尸进程数阈值 (单位: 个)
  zombie_processes:
    warning: 1 # 僵尸进程 > 0 触发警告
    critical: 10 # 僵尸进程 > 10 触发严重告警

  # 单核负载阈值 (无单位)
  # 计算方式: 系统负载 / CPU 核心数
  load_per_core:
    warning: 0.7 # 单核负载 > 0.7 触发警告
    critical: 1.0 # 单核负载 > 1.0 触发严重告警

# -----------------------------------------------------------------------------
# 报告配置
# -----------------------------------------------------------------------------
report:
  # 报告输出目录 (默认: ./reports)
  output_dir: "./reports"

  # 输出格式 (默认: [excel, html])
  # 可选值: excel, html
  formats:
    - excel
    - html

  # 文件名模板 (默认: inspection_report_{{.Date}})
  # 支持的变量: {{.Date}} - 日期 (YYYYMMDD)
  # 生成示例: inspection_report_20251213.xlsx, inspection_report_20251213.html
  filename_template: "inspection_report_{{.Date}}"

  # HTML 报告模板路径 (可选)
  # 不配置则使用内置默认模板
  # 配置后优先加载用户自定义模板
  # html_template: "./templates/html/report.tmpl"

  # 时区设置 (默认: Asia/Shanghai)
  # 影响: 巡检时间、最后重启时间、报告生成时间的显示
  timezone: "Asia/Shanghai"

# -----------------------------------------------------------------------------
# 日志配置
# -----------------------------------------------------------------------------
logging:
  # 日志级别 (默认: info)
  # 可选值: debug, info, warn, error
  level: info

  # 日志格式 (默认: json)
  # 可选值: json, console
  # json: 结构化 JSON 格式，适合日志采集系统
  # console: 人类可读格式，适合开发调试
  format: json

# -----------------------------------------------------------------------------
# HTTP 客户端配置
# -----------------------------------------------------------------------------
http:
  # 重试策略配置
  retry:
    # 最大重试次数 (默认: 3, 范围: 0-10)
    # 设置为 0 表示不重试
    max_retries: 3

    # 基础重试延迟 (默认: 1s)
    # 采用指数退避策略: 1s, 2s, 4s...
    # 可重试的错误类型: 超时、5xx 响应、连接失败
    # 4xx 错误不会重试
    base_delay: 1s

# -----------------------------------------------------------------------------
# MySQL 数据库巡检配置
# -----------------------------------------------------------------------------
# 用途: MySQL 8.0 MGR 集群巡检（支持主从/双主模式扩展）
# 数据来源: VictoriaMetrics（通过 Categraf 采集的 mysql_* 指标）
mysql:
  # 是否启用 MySQL 巡检 (默认: false)
  enabled: true

  # 集群模式 (必须手动指定，不支持自动检测)
  # 可选值: mgr, dual-master, master-slave
  # - mgr: MySQL 8.0 MGR 模式 (1主N从)
  # - dual-master: 双主模式
  # - master-slave: 传统主从模式
  cluster_mode: "mgr"

  # 实例筛选条件 (可选)
  # 不配置则查询所有 MySQL 实例
  instance_filter:
    # 地址匹配模式 (支持通配符 *)
    # 示例: "172.18.182.*" 匹配该网段所有实例
    # 示例: "*:3306" 匹配所有 3306 端口实例
    address_patterns:
      # - "172.18.182.*"
      # - "*:33306"

    # 业务组筛选 (OR 关系)
    # 匹配任意一个业务组的实例都会被纳入巡检
    business_groups:
      # - "生产MySQL"
      # - "测试MySQL"

    # 标签筛选 (AND 关系)
    # 与业务组条件之间是 AND 关系
    tags:
      # env: "prod"
      # app: "mysql"

  # 阈值配置
  thresholds:
    # 连接使用率阈值 (单位: %)
    # 计算方式: (当前连接数 / 最大连接数) * 100
    connection_usage_warning: 70   # 连接使用率 > 70% 触发警告
    connection_usage_critical: 90  # 连接使用率 > 90% 触发严重告警

    # MGR 期望成员数 (默认: 3)
    # 仅在 cluster_mode: mgr 时生效
    # 支持配置为 3/5/7/9 等奇数（符合 MGR 最佳实践）
    # 告警规则:
    #   - 成员数 = expected: 正常
    #   - 成员数 = expected - 1: 警告 (掉 1 个节点)
    #   - 成员数 < expected - 1: 严重 (掉 2 个及以上节点)
    mgr_member_count_expected: 3

# -----------------------------------------------------------------------------
# Redis 集群巡检配置
# -----------------------------------------------------------------------------
# 用途: Redis 6.2 Cluster 集群巡检（支持 3主3从/3主6从）
# 数据来源: VictoriaMetrics（通过 Categraf 采集的 redis_* 指标）
redis:
  # 是否启用 Redis 巡检 (默认: false)
  enabled: true

  # 集群模式 (必须手动指定)
  # 可选值: 3m3s (3主3从), 3m6s (3主6从)
  # - 3m3s: 每个 master 期望 1 个 slave（默认）
  # - 3m6s: 每个 master 期望 2 个 slave
  cluster_mode: "3m3s"

  # 实例筛选条件 (可选)
  # 不配置则查询所有 Redis 实例
  instance_filter:
    # 地址匹配模式 (支持通配符 *)
    # 示例: "192.18.102.*" 匹配该网段所有实例
    # 示例: "*:7000" 匹配所有 7000 端口实例
    address_patterns:
      # - "192.18.102.*"

    # 业务组筛选 (OR 关系)
    # 匹配任意一个业务组的实例都会被纳入巡检
    business_groups:
      # - "生产Redis"

    # 标签筛选 (AND 关系)
    # 与业务组条件之间是 AND 关系
    tags:
      # env: "prod"

  # 阈值配置
  thresholds:
    # 连接使用率阈值 (单位: %)
    # 计算方式: (当前连接数 / 最大连接数) * 100
    connection_usage_warning: 70   # 连接使用率 > 70% 触发警告
    connection_usage_critical: 90  # 连接使用率 > 90% 触发严重告警

    # 复制延迟阈值 (单位: 字节)
    # 计算方式: slave 的 master_repl_offset - slave_repl_offset
    # 注意: 目前无生产环境经验值，以下为保守默认值
    # 建议根据实际业务负载和网络情况调整
    # 正常情况下复制延迟应该很小（KB级）
    replication_lag_warning: 1048576    # 1MB - 保守警告阈值
    replication_lag_critical: 10485760  # 10MB - 保守严重阈值

# -----------------------------------------------------------------------------
# Nginx 巡检配置
# -----------------------------------------------------------------------------
# 用途: Nginx/OpenResty 巡检（支持二进制部署和容器部署）
# 数据来源: VictoriaMetrics（通过 Categraf nginx 插件 + exec 脚本采集的 nginx_* 指标）
nginx:
  # 是否启用 Nginx 巡检 (默认: false)
  enabled: true

  # 实例筛选条件 (可选)
  # 不配置则查询所有 Nginx 实例
  instance_filter:
    # 主机名匹配模式 (支持通配符 *)
    # 示例: "GX-NM-*" 匹配所有以 GX-NM- 开头的主机
    # 示例: "*-NGX-*" 匹配主机名包含 -NGX- 的主机
    hostname_patterns:
      # - "GX-NM-*"
      # - "*-NGX-*"

    # 业务组筛选 (OR 关系)
    # 匹配任意一个业务组的实例都会被纳入巡检
    business_groups:
      # - "生产Nginx"
      # - "OpenResty集群"

    # 标签筛选 (AND 关系)
    # 与业务组条件之间是 AND 关系
    tags:
      # env: "prod"
      # component: "nginx"

  # 阈值配置
  thresholds:
    # 连接使用率阈值 (单位: %)
    # 计算方式: active_connections / (worker_processes * worker_connections) * 100
    connection_usage_warning: 70   # 连接使用率 > 70% 触发警告
    connection_usage_critical: 90  # 连接使用率 > 90% 触发严重告警

    # 最近错误日志时间阈值 (单位: 分钟)
    # 检测 error.log 最后一条错误日志距今的时间
    # 注意: 时间越短越严重，因此 warning > critical
    last_error_warning_minutes: 60   # 1小时内有错误触发警告
    last_error_critical_minutes: 10  # 10分钟内有错误触发严重告警

# -----------------------------------------------------------------------------
# Tomcat 巡检配置
# -----------------------------------------------------------------------------
# 用途: Tomcat 应用巡检（支持容器部署和二进制部署）
# 数据来源: VictoriaMetrics（通过 Categraf exec 脚本采集的 tomcat_* 指标）
tomcat:
  # 是否启用 Tomcat 巡检 (默认: false)
  enabled: true

  # 实例筛选条件 (可选)
  # 不配置则查询所有 Tomcat 实例
  instance_filter:
    # 主机名匹配模式 (支持通配符 *)
    # 示例: "GX-MFUI-*" 匹配所有以 GX-MFUI- 开头的主机
    # 示例: "*-BE-*" 匹配主机名包含 -BE- 的主机
    hostname_patterns:
      # - "GX-MFUI-*"
      # - "*-BE-*"

    # 容器名匹配模式 (支持通配符 *)
    # 示例: "tomcat-18001" 匹配具体容器
    # 示例: "tomcat-*" 匹配所有以 tomcat- 开头的容器
    # 注意: 二进制部署的实例无 container 标签，不会被此规则匹配
    container_patterns:
      # - "tomcat-*"
      # - "*-18001"

    # 业务组筛选 (OR 关系)
    # 匹配任意一个业务组的实例都会被纳入巡检
    business_groups:
      # - "生产Tomcat"
      # - "短剧项目"

    # 标签筛选 (AND 关系)
    # 与业务组条件之间是 AND 关系
    tags:
      # env: "prod"
      # app: "tomcat"

  # 阈值配置
  thresholds:
    # 最近错误日志时间阈值 (单位: 分钟)
    # 检测 error.log 最后一条错误日志距今的时间
    # 注意: 时间越短越严重，因此 warning > critical
    # 示例: 如果最后一条错误日志是 5 分钟前，触发严重告警
    last_error_warning_minutes: 60   # 1小时内有错误触发警告
    last_error_critical_minutes: 10  # 10分钟内有错误触发严重告警
